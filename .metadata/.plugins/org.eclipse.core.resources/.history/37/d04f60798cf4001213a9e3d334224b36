package br.usp.ime.tcc.utils;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Locale;

import android.content.ContentResolver;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.BitmapFactory.Options;
import android.graphics.Matrix;
import android.net.Uri;
import android.provider.MediaStore;

public final class Utils {
	private Utils() {
		throw new AssertionError();
	}
	
	private static boolean photoIsBiggerThanRequired(int reqWidth,
			int reqHeight, final int height, final int width) {
		return height > reqHeight || width > reqWidth;
	}

	private static int calculateInSampleSize(Options options, int reqWidth,
			int reqHeight) {
		final int height = options.outHeight;
		final int width = options.outWidth;
		int inSampleSize = 1;

		if (photoIsBiggerThanRequired(reqWidth, reqHeight, height, width)) {
			final int heightRatio = Math.round((float) height
					/ (float) reqHeight);
			final int widthRatio = Math.round((float) width / (float) reqWidth);

			inSampleSize = heightRatio < widthRatio ? heightRatio : widthRatio;
		}
		return inSampleSize;
	}

	private static String queryForPicturePath(Uri selectedImageUri,
			ContentResolver cr) {
		String[] filePathColumn = { MediaStore.Images.Media.DATA };

		Cursor cursor = cr.query(selectedImageUri, filePathColumn, null, null,
				null);
		cursor.moveToFirst();

		int columnIndex = cursor.getColumnIndex(filePathColumn[0]);
		String picturePath = cursor.getString(columnIndex);
		cursor.close();
		return picturePath;
	}
	
	private static Bitmap rotateBitmap(Bitmap bmp, float degrees) {
		Matrix matrix = new Matrix();
		matrix.postRotate(degrees);
		return Bitmap.createBitmap(bmp, 0, 0,
				bmp.getWidth(), bmp.getHeight(),
				matrix, true);
	}

	// Public Methods

	public static String getSelectedPicturePath(Uri selectedImageUri,
			ContentResolver cr) {
		String picturePath = null;

		if (selectedImageUri != null) 
			picturePath = queryForPicturePath(selectedImageUri, cr);
		return picturePath;
	}

	public static String getTimeStamp() {
		String timeStamp = new SimpleDateFormat(Constants.DATE_FORMAT,
				Locale.getDefault()).format(new Date());
		return timeStamp;
	}

	public static Bitmap getScaledBitmapFromImagePath(String imagePath,
			int imageOrientation) {
		Options options = new Options();
		options.inJustDecodeBounds = true;
		BitmapFactory.decodeFile(imagePath, options);

		options.inSampleSize = calculateInSampleSize(options,
				Constants.REQWIDTH, Constants.REQHEIGHT);
		options.inJustDecodeBounds = false;

		Bitmap bmp = BitmapFactory.decodeFile(imagePath, options);

		if (imageOrientation == 90)
				return rotateBitmap(bmp, 90);
		return bmp;
	}

	public static int getOrientation(Uri photoUri, ContentResolver cr) {
		int orientation = 0;
		
		int orientation = queryForImageOrientation(photoUri, cr);
		return orientation;
	}

	private static int queryForImageOrientation(Uri photoUri, ContentResolver cr) {
		String[] fileOrientationColumn = { MediaStore.Images.ImageColumns.ORIENTATION };

		Cursor cursor = cr.query(photoUri, fileOrientationColumn, null, null,
				null);

		cursor.moveToFirst();
		int orientation = cursor.getInt(0);
		cursor.close();
		return orientation;
	}
}
